!function(){"use strict";const t=self,e=16,s=80,o=15,n={type:0,light:1,sunlight:2,count:3},r=new Map;let a,i=1;const l=(t,e)=>({x:t,z:e,voxels:new Uint8ClampedArray(20480*n.count),heightmap:new Uint8ClampedArray(256),hasPropagated:!1}),c=(t,e)=>{const s=`${t}:${e}`;let o=r.get(s);return o||(o={...l(t,e),key:s},r.set(s,o)),o},h=(t,o,r)=>(t*e*s+o*e+r)*n.count,u=t=>(s,o)=>{let n=t;const r=s<0||s>=e?Math.floor(s/e):0,a=o<0||o>=e?Math.floor(o/e):0;return(r||a)&&(n=c(t.x+r,t.z+a),s-=e*r,o-=e*a),{chunk:n,cx:s,cz:o}},p=[{x:1,y:0,z:0},{x:-1,y:0,z:0},{x:0,y:0,z:1},{x:0,y:0,z:-1},{x:0,y:1,z:0},{x:0,y:-1,z:0}],x=(t,r,i="light")=>{const l=u(t),c="sunlight"===i;for(;r.length;){const{x:t,y:u,z:x}=r.shift(),{chunk:f,cx:z,cz:y}=l(t,x),g=f.voxels[h(z,u,y)+n[i]];p.forEach((p=>{const f=u+p.y;if(f<0||f>=s)return;const z=t+p.x,y=x+p.z,m=g-(c&&-1===p.y&&g===o?0:1),{chunk:d,cx:v,cz:k}=l(z,y),M=h(v,f,k);var T;(T=d.voxels[M],!a[T].isTranslucent||c&&-1!==p.y&&g===o&&f>d.heightmap[v*e+k]||d.voxels[M+n[i]]>=m)||(d.voxels[M+n[i]]=m,r.push({x:z,y:f,z:y}))}))}},f=t=>{const r=[],i=[];for(let l=0;l<e;l+=1)for(let c=0;c<s;c+=1)for(let s=0;s<e;s+=1){const e=h(l,c,s),u=t.voxels[e];79===c&&a[u].isTranslucent?(t.voxels[e+n.sunlight]=o,i.push({x:l,y:79,z:s})):a[u].isLight&&(t.voxels[e+n.light]=o,r.push({x:l,y:c,z:s}))}x(t,r,"light"),x(t,i,"sunlight"),t.hasPropagated=!0},z=(t,e,r,a,i="light")=>{const l=u(t),{chunk:c,cx:f,cz:z}=l(e,a),y=h(f,r,z),g=[],m=[];m.push({x:e,y:r,z:a,light:c.voxels[y+n[i]]}),c.voxels[y+n[i]]=0;const d="sunlight"===i;for(;m.length;){const{x:t,y:e,z:r,light:a}=m.shift();p.forEach((c=>{const u=e+c.y;if(u<0||u>=s)return;const p=t+c.x,x=r+c.z,{chunk:f,cx:z,cz:y}=l(p,x),v=h(z,u,y),k=f.voxels[v+n[i]];0!==k&&(k<a||d&&-1===c.y&&a===o&&k===o?(m.push({x:p,y:u,z:x,light:k}),f.voxels[v+n[i]]=0):k>=a&&g.push({x:p,y:u,z:x}))}))}x(t,g,i)},y=({light:t,sunlight:e},s)=>s.map((s=>{let n=a[s[0].type].hasAO,r=a[s[1].type].hasAO,l=n&&r||a[s[2].type].hasAO;const c=[n,r,l].reduce(((t,e)=>t-(e?.2:0)),1);let h=1,u=t,p=e;return n=a[s[0].type].isTranslucent,r=a[s[1].type].isTranslucent,l=(n||r)&&a[s[2].type].isTranslucent,[n,r,l].forEach(((t,e)=>{t&&(u+=s[e].light,p+=s[e].sunlight,h+=1)})),Math.max(Math.max(u,p*i)/h/o,.05)*c})),g={type:0,light:0,sunlight:o},m=(t,e)=>!a[t].isCulled||!a[e].isCulled||a[e].isTransparent&&(!a[t].isTransparent||t!==e),d=[{x:-1,z:-1},{x:0,z:-1},{x:1,z:-1},{x:-1,z:0},{x:1,z:0},{x:-1,z:1},{x:0,z:1},{x:1,z:1}],v=1/18,k=17/18,M=new Map,T=(t,r)=>{const l=c(t,r);M.has(l.key)||M.set(l.key,l),l.hasPropagated||f(l),d.forEach((({x:t,z:e})=>{const s=c(l.x+t,l.z+e);s.hasPropagated||f(s)}));const p=(t=>{const e=u(t);return(t,o,r)=>{if(o<0||o>=s)return g;const{chunk:a,cx:i,cz:l}=e(t,r),c=h(i,o,l);return{type:a.voxels[c],light:a.voxels[c+n.light],sunlight:a.voxels[c+n.sunlight]}}})(l);return[...Array(5)].map(((t,s)=>{const n={opaque:{color:[],position:[],uv:[],index:[],offset:0},transparent:{color:[],position:[],uv:[],index:[],offset:0}},r=(t,e,s,o,r,i,l)=>{const c=a[r].textures[l%6],h=[[c.from,l+k],[c.to,l+k],[c.to,l+v],[c.from,l+v]],u=[t,e,s,o];i[0]+i[2]<i[1]+i[3]&&(i.unshift(i.pop()),h.unshift(h.pop()),u.unshift(u.pop()));const p=a[r].isTransparent?n.transparent:n.opaque;i.forEach((t=>p.color.push(t,t,t))),h.forEach((t=>p.uv.push(...t))),u.forEach((t=>p.position.push(...t))),[0,1,2,2,3,0].forEach((t=>p.index.push(p.offset+t))),p.offset+=4},l=(t,e,s,o)=>{const n=p(t,e+1,s),a=p(t,e-1,s),i=p(t,e,s+1),l=p(t,e,s-1),c=p(t-1,e,s),h=p(t+1,e,s);if(m(o,n.type)){const a=p(t,e+1,s-1),i=p(t+1,e+1,s),l=p(t-1,e+1,s),c=p(t,e+1,s+1);r([t,e+1,s+1],[t+1,e+1,s+1],[t+1,e+1,s],[t,e+1,s],o,y(n,[[l,c,p(t-1,e+1,s+1)],[i,c,p(t+1,e+1,s+1)],[i,a,p(t+1,e+1,s-1)],[l,a,p(t-1,e+1,s-1)]]),0)}if(m(o,a.type)){const n=p(t,e-1,s-1),i=p(t+1,e-1,s),l=p(t-1,e-1,s),c=p(t,e-1,s+1);r([t,e,s],[t+1,e,s],[t+1,e,s+1],[t,e,s+1],o,y(a,[[l,n,p(t-1,e-1,s-1)],[i,n,p(t+1,e-1,s-1)],[i,c,p(t+1,e-1,s+1)],[l,c,p(t-1,e-1,s+1)]]),1)}if(m(o,i.type)){const n=p(t+1,e,s+1),a=p(t-1,e,s+1),l=p(t,e+1,s+1),c=p(t,e-1,s+1);r([t,e,s+1],[t+1,e,s+1],[t+1,e+1,s+1],[t,e+1,s+1],o,y(i,[[a,c,p(t-1,e-1,s+1)],[n,c,p(t+1,e-1,s+1)],[n,l,p(t+1,e+1,s+1)],[a,l,p(t-1,e+1,s+1)]]),2)}if(m(o,l.type)){const n=p(t+1,e,s-1),a=p(t-1,e,s-1),i=p(t,e+1,s-1),c=p(t,e-1,s-1);r([t+1,e,s],[t,e,s],[t,e+1,s],[t+1,e+1,s],o,y(l,[[n,c,p(t+1,e-1,s-1)],[a,c,p(t-1,e-1,s-1)],[a,i,p(t-1,e+1,s-1)],[n,i,p(t+1,e+1,s-1)]]),3)}if(m(o,c.type)){const n=p(t-1,e,s-1),a=p(t-1,e,s+1),i=p(t-1,e+1,s),l=p(t-1,e-1,s);r([t,e,s],[t,e,s+1],[t,e+1,s+1],[t,e+1,s],o,y(c,[[n,l,p(t-1,e-1,s-1)],[a,l,p(t-1,e-1,s+1)],[a,i,p(t-1,e+1,s+1)],[n,i,p(t-1,e+1,s-1)]]),4)}if(m(o,h.type)){const n=p(t+1,e,s-1),a=p(t+1,e,s+1),i=p(t+1,e+1,s),l=p(t+1,e-1,s);r([t+1,e,s+1],[t+1,e,s],[t+1,e+1,s],[t+1,e+1,s+1],o,y(h,[[a,l,p(t+1,e-1,s+1)],[n,l,p(t+1,e-1,s-1)],[n,i,p(t+1,e+1,s-1)],[a,i,p(t+1,e+1,s+1)]]),5)}},c=(t,e,s,{type:n,light:a,sunlight:l})=>{const c=(()=>{const t=Math.max(Math.max(a,l*i)/o,.05);return[...Array(4)].map((()=>t))})();r([t,e,s],[t+1,e,s+1],[t+1,e+1,s+1],[t,e+1,s],n,c,6),r([t,e,s+1],[t+1,e,s],[t+1,e+1,s],[t,e+1,s+1],n,c,6),r([t+1,e,s+1],[t,e,s],[t,e+1,s],[t+1,e+1,s+1],n,c,6),r([t+1,e,s],[t,e,s+1],[t,e+1,s+1],[t+1,e+1,s],n,c,6)},h=s*e,u=(s+1)*e;for(let t=0;t<e;t+=1)for(let s=h;s<u;s+=1)for(let o=0;o<e;o+=1){const e=p(t,s,o);if(0!==e.type)switch(a[e.type].model){case"cross":c(t,s,o,e);break;default:l(t,s,o,e.type)}}return["opaque","transparent"].reduce(((t,e)=>{const{color:s,position:o,uv:r,index:a}=n[e];return t[e]={color:new Float32Array(s),position:new Uint8Array(o),uv:new Float32Array(r),index:new Uint16Array(a)},t}),{})}))},$=(e,s)=>{const o=T(e,s);t.postMessage({type:"chunk",position:{x:e,z:s},subchunks:o},o.reduce(((t,e)=>(["opaque","transparent"].forEach((s=>{s=e[s],t.push(s.color.buffer,s.position.buffer,s.uv.buffer,s.index.buffer)})),t)),[]))},b=(()=>{let t;const e=new Map,s=()=>{[...e.values()].forEach((t=>$(t.x,t.z))),e.clear()};return(o,n)=>{e.set(`${o}:${n}`,{x:o,z:n}),t&&clearTimeout(t),t=setTimeout(s,0)}})(),E=(()=>{let t;const e=()=>{const t=[...M.values()];t.length?t.forEach((t=>$(t.x,t.z))):$(0,0)};return()=>{t&&clearTimeout(t),t=setTimeout(e,0)}})(),A=({offset:t={x:-8,y:-1,z:-8}})=>{const o=(t,o,n)=>{if(o<0||o>=s)return!1;const r=`${Math.floor(t/e)}:${Math.floor(n/e)}`,i=M.get(r);if(!i)return!1;t-=e*i.x,n-=e*i.z;const l=i.voxels[h(t,o,n)];return 0!==l&&"cross"!==a[l].model},{min:n,max:r}=[...M.values()].reduce((({min:t,max:s},{x:o,z:n})=>({min:{x:Math.min(t.x,o*e),z:Math.min(t.z,n*e)},max:{x:Math.max(s.x,(o+1)*e),z:Math.max(s.z,(n+1)*e)}})),{min:{x:1/0,z:1/0},max:{x:-1/0,z:-1/0}}),i=[],l=new Map;for(let t=n.x;t<r.x;t+=1)for(let e=0;e<s;e+=1)for(let a=n.z;a<r.z;a+=1)if(o(t,e,a)&&!l.has(`${t}:${e}:${a}`)){const n={position:{x:t,y:e,z:a},size:{x:0,y:0,z:0}};i.push(n);for(let s=t+1;s<=r.x;s+=1)if(!o(s,e,a)||l.has(`${s}:${e}:${a}`)){n.size.x=s-t;break}n.size.y=s-e;for(let s=t;s<t+n.size.x;s+=1)for(let t=e+1;t<=e+n.size.y;t+=1)o(s,t,a)&&!l.has(`${s}:${t}:${a}`)||(n.size.y=t-e);n.size.z=r.z-a;for(let s=t;s<t+n.size.x;s+=1)for(let t=e;t<e+n.size.y;t+=1)for(let e=a+1;e<=a+n.size.z;e+=1)o(s,t,e)&&!l.has(`${s}:${t}:${e}`)||(n.size.z=e-a);for(let s=t;s<t+n.size.x;s+=1)for(let t=e;t<e+n.size.y;t+=1)for(let e=a;e<a+n.size.z;e+=1)l.set(`${s}:${t}:${e}`,!0)}return i.map((({position:e,size:s})=>[[e.x+t.x,e.y+t.y,e.z+t.z],[s.x,s.y,s.z]]))};t.addEventListener("message",(({data:l})=>{switch(l.type){case"types":{const t=a,e={opaque:0,transparent:0};if(a=[{name:"Air",isLight:!1,isTranslucent:!0},...l.types.map((t=>{const s=t.isTransparent?"transparent":"opaque",o=e[s];return e[s]+=3,{...t,hasAO:"cross"!==t.model,isCulled:"cross"!==t.model,isTranslucent:t.isTransparent||"cross"===t.model,textures:[o+2,o,o+1,o+1,o+1,o+1]}})).map((t=>({...t,textures:t.textures.map((s=>{const o=1/e[t.isTransparent?"transparent":"opaque"],n=o/18,r=s*o+n;return{from:r,to:r+16*n}}))})))],t){let e=!1,s=!1;if(a.length<t.length)e=!0,s=t.map((({key:t})=>{if(!t)return 0;const e=a.findIndex((({key:e})=>e===t));return~e?e:0}));else{const s=t.length;for(let o=0;o<s;o+=1){const s=t[o],n=a[o];if(s.model!==n.model||s.isLight!==n.isLight||s.isTransparent!==n.isTransparent){e=!0;break}}}e&&([...r.values()].forEach((({key:t})=>{M.has(t)||r.delete(t)})),[...M.values()].forEach((t=>{const{voxels:e}=t,{length:r}=e;for(let t=0;t<r;t+=n.count)s&&(e[t]=s[e[t]]),e[t+n.light]=a[e[t]].isLight?o:0,e[t+n.sunlight]=0;t.hasPropagated=!1})))}E();break}case"sunlight":i=l.intensity,E();break;case"update":if(l.update.y>0&&l.update.y<s){const t=(({x:t,y:r,z:i,type:l})=>{const f=c(Math.floor(t/e),Math.floor(i/e));t-=e*f.x,i-=e*f.z;const{heightmap:y,voxels:g,hasPropagated:m}=f,d=h(t,r,i),v=g[d];g[d]=l;const k=t*e+i,M=y[k];if(l===a.air){if(r===M)for(let e=r-1;e>=0;e-=1)if(0===e||0!==g[h(t,e,i)]){y[k]=e;break}}else M<r&&(y[k]=r);if(m)if(a[v].isLight?z(f,t,r,i):a[v].isTranslucent&&!a[l].isTranslucent&&["light","sunlight"].forEach((e=>{0!==g[d+n[e]]&&z(f,t,r,i,e)})),a[l].isLight)g[d+n.light]=o,x(f,[{x:t,y:r,z:i}]);else if(a[l].isTranslucent&&!a[v].isTranslucent){const e=u(f);["light","sunlight"].forEach((l=>{const c=[];"sunlight"===l&&79===r?(g[d+n[l]]=o,c.push({x:t,y:r,z:i})):p.forEach((o=>{const u=r+o.y;if(u<0||u>=s)return;const p=t+o.x,x=i+o.z,{chunk:f,cx:z,cz:y}=e(p,x),g=h(z,u,y),{isLight:m,isTranslucent:d}=a[f.voxels[g]];0!==f.voxels[g+n[l]]&&(d||m&&"light"===l)&&c.push({x:p,y:u,z:x})})),x(f,c,l)}))}return f})(l.update);[t,...d.map((({x:e,z:s})=>({x:t.x+e,z:t.z+s})))].forEach((t=>b(t.x,t.z)))}break;case"pick":{const{block:o}=l;if(o.y>0&&o.y<s){const s=c(Math.floor(o.x/e),Math.floor(o.z/e));o.x-=e*s.x,o.z-=e*s.z,t.postMessage({type:"pick",block:s.voxels[h(o.x,o.y,o.z)]})}break}case"load":r.clear(),M.clear(),a=void 0,l.chunks.forEach((({x:t,z:a,voxels:i})=>{const c=`${t}:${a}`,h=new Uint8ClampedArray(atob(i).split("").map((t=>t.charCodeAt(0)))),u=new Uint8ClampedArray(20480*n.count),p=new Uint8ClampedArray(256);for(let t=0,r=0,a=0;t<e;t+=1)for(let i=0;i<s;i+=1)for(let s=0;s<e;s+=1,r+=n.count,a+=1){const c=h[a];if(u[r]=c,0!==c){const a=t*e+s;p[a]<i&&(p[a]=i),l.types[c-1].isLight&&(u[r+n.light]=o)}}const x={x:t,z:a,voxels:u,heightmap:p,hasPropagated:!1,key:c};r.set(c,x),M.set(c,x)}));break;case"save":t.postMessage({type:"save",chunks:[...M.values()].map((({x:t,z:e,voxels:s})=>{const o=new Uint8ClampedArray(20480),{length:r}=s;for(let t=0,e=0;t<r;t+=1,e+=n.count)o[t]=s[e];return{x:t,z:e,voxels:btoa(String.fromCharCode.apply(null,o))}}))});break;case"computePhysics":t.postMessage({type:"physics",boxes:A(l)});break;case"reset":r.clear(),M.clear()}}))}();
//# sourceMappingURL=blocks.worker.js.map
